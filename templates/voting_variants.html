{% extends "empty_layout.html" %}
{% block title %}{{ voting['name'] }} :: {% endblock %}
{% block body %}

{% if not user.is_authenticated() %}
<div class="modal" id="frmAuth">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">{{ _('Sign in') }}</h4>
            </div>
            <div class="modal-body">
                {% if config.AUTH_VKONTAKTE %}
                <a href="javascript:void(0);" data-auth-method="vkontakte" class="btn btn-default btn-social btn-social-vk">Вконтакте</a>
                {% endif %}
                {#
                <a href="javascript:void(0);" data-auth-method="facebook" class="btn btn-default btn-social btn-social-fb">Facebook</a>
                <a href="javascript:void(0);" data-auth-method="twitter" class="btn btn-default btn-social btn-social-twitter">Twitter</a>
                <a href="javascript:void(0);" data-auth-method="google" class="btn btn-default btn-social btn-social-google">Google</a>
                #}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $('#frmAuth .modal-body a.btn-social').click(function(e) {
        $('#frmAuth').modal('hide');
        $('#frmVote')
            .data('auth-method', $(this).data('auth-method'))
            .submit();
    });
</script>
{% endif %}

<ol class="breadcrumb">
    <li><a href="{{ url_for('voting.voting_list') }}">{{ _('Votings') }}</a></li>
    <li>{{ voting['name'] }}</li>
</ol>

{% if current_user.is_authenticated() and voting.owner == current_user %}
<div class="btn-toolbar">
    <a href="{{ url_for('voting.variant_new', voting_id=voting.id) }}" class="btn btn-success btn-xs"><span class="glyphicon glyphicon-plus"></span> {{ _('Add variant') }}</a>
</div>
<hr>
{% endif %}

<h1>{{ voting['name'] }}</h1>

<div class="row-fluid">
    <div class="col-md-6">
        <div class="panel panel-info">
            <div class="panel-heading">{{ _('Variants') }}</div>
            <ul id="variants" class="votingPanel list-group">
                {% for variant in voting.variants %}
                <li class="list-group-item">
                    <input type="hidden" name="variant[]" value="{{ variant.id }}"/>
                    <h4 class="list-group-item-heading">{{ variant.title }}</h4>

                    <p class="list-group-item-text">{{ variant.description }}</p>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="col-md-6">
        <form id="frmVote" method="post" action="{{ url_for('vote.vote_save', voting_id=voting['id']) }}" data-auth-method="{{ user.is_authenticated() }}">
            <div class="panel panel-success">
                <div class="panel-heading">
                    {{ _('Vote') }}
                    <button type="submit" class="btn btn-danger btn-xs pull-right" style="display: none;">
                        <span class="glyphicon glyphicon-send"></span> {{ _('Vote') }}
                    </button>
                </div>

                <ul id="vote" class="votingPanel list-group">
                </ul>
            </div>
        </form>

        <ul class="bg-info" style="padding: 10px 50px;">
            <li>{{ _('Drop variants in order of your favour') }}</li>
            <li>{{ _('Skip variants you don\'t want to vote for') }}</li>
        </ul>
    </div>
</div>

<script type="text/javascript">
    // sort votes
    $("#variants, #vote")
    .sortable({
        connectWith: ".votingPanel",
        placeholder: 'drop-placeholder',
        helper: function(e, elem) {
            console.log(elem);
            return elem.clone().addClass('drag-helper');
        },
        update: function(e, ui) {
            if($('#vote li').length) {
                $('#frmVote button[type=submit]').show();
            }
            else {
                $('#frmVote button[type=submit]').hide()
            }

        }
    })
    .disableSelection();

    // send form
    $('#frmVote').submit(function(e) {
        e.preventDefault();
        var $frm = $(this);

        // check auth
        var authMethod = $frm.data('auth-method');
        if(authMethod === 'False') {
            // show login form
            $('#frmAuth').modal();
        } else if(authMethod === 'True') {
            // save vote for authorised user
            $.post($frm.attr('action'), $frm.serialize(), function(response) {
                if(response.error == 0) {
                    location.href = response.redirect_url;
                }
            }, 'json');
        } else {
            // save vote in session for unauthorised user
            $.post($frm.attr('action'), $frm.serialize() + '&auth_method=' + authMethod, function(response) {
                if(response.error == 0) {
                    location.href = response.redirect_url;
                }
            }, 'json');
        }

    })

</script>

{% endblock %}